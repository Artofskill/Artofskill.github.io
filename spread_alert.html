<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spread Alert by Artofskill</title>
    <style>
        /* Базовые стили (оставлены без изменений) */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #0d1117; 
            color: #c9d1d9; 
            margin: 0; 
            padding: 0;
        }
        h1 { 
            text-align: center; 
            color: #58a6ff; 
            font-size: 1.8em; 
            margin: 15px 0 20px 0; 
        }

        /* Блок времени вверху */
        .time-block {
            background: #161b22;
            height: 100px;
            margin: 0 15px 15px 15px;
            border-radius: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
        }

        .ntp-time {
            font-size: 3.5em;
            font-weight: bold;
            color: #ffa657;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px rgba(255, 165, 87, 0.5);
        }

        /* Стили для десктопной версии */
        .wrapper { 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            width: 100%;
            margin: 0;
            padding: 0 15px;
            box-sizing: border-box;
        }

        .block { 
            background: #161b22; 
            padding: 18px;
            border-radius: 16px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.6); 
            height: 667px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .block h2 { 
            color: #ffa657; 
            margin: 0 0 12px 0; 
            font-size: 1.2em;
            text-align: center;
        }

        input, button, select { 
            padding: 8px 10px;
            font-size: 14px;
            border-radius: 8px; 
            border: none; 
            margin: 4px 0; 
        }
        input { 
            background: #21262d; 
            color: white; 
            text-align: center; 
            width: 100%; 
        }
        select {
            background: #21262d;
            color: white;
            width: 100%;
        }
        button { 
            background: #58a6ff; 
            color: black; 
            font-weight: bold; 
            cursor: pointer; 
        }

        .funding-result {
            margin-top: 12px;
            padding: 15px;
            background: #21262d;
            border-radius: 12px;
            font-size: 1.0em;
            line-height: 1.5;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .funding-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 0 5px;
        }

        .funding-label {
            color: #ffa657;
            font-weight: 600;
        }

        .funding-value {
            font-weight: bold;
        }

        .funding-positive { color: #56d364; }
        .funding-negative { color: #ff7b72; }

        .funding-summary {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #30363d;
            font-size: 1.0em;
            font-weight: bold;
        }

        button:hover { background: #79c0ff; }
        button.stop { background: #ff4444; }
        button.stop:hover { background: #ff6666; }

        .content { 
            flex: 1; 
            background: #21262d; 
            border-radius: 12px; 
            padding: 15px;
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            font-size: 1.0em;
            line-height: 1.5;
        }

        /* Единые размеры для всех блоков */
        .ticker-big { 
            font-size: 1.5em; 
            font-weight: 700; 
            color: #58a6ff; 
            margin-bottom: 8px; 
        }
        
        .spread-big { 
            font-size: 2.2em; 
            font-weight: 700; 
            margin: 10px 0; 
        }
        
        .my-spread-num { 
            font-size: 2.0em; 
            font-weight: 700; 
            color: #7ffe94; 
            margin: 10px 0; 
        }
        
        .current-profit-num { 
            font-size: 2.0em; 
            font-weight: 700; 
            margin: 10px 0; 
        }

        .positive { color: #56d364; }
        .negative { color: #ff7b72; }

        .alert-min { animation: flash 0.8s infinite; background: #166534 !important; color: white; }
        .alert-max { animation: flash 0.8s infinite; background: #7f1d1d !important; color: white; }
        @keyframes flash { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Стили для PnL */
        .pnl-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #30363d;
        }

        .pnl-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .pnl-label {
            font-weight: 600;
        }

        .pnl-value {
            font-weight: bold;
        }

        /* Новая улучшенная структура для блока "Моя позиция" */
        .position-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .position-row {
            display: flex;
            justify-content: space-between;
            align-items: stretch; /* Выравнивание по высоте */
            gap: 10px;
        }

        .position-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 80px; /* Фиксированная минимальная высота для выравнивания */
        }

        .position-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffa657;
            margin-bottom: 5px;
            text-align: center;
        }

        .position-subtitle {
            font-size: 0.8em;
            color: #8b949e;
            margin-bottom: 3px;
            text-align: center;
        }

        .position-input {
            width: 100%;
            max-width: 120px;
            margin: 0 auto;
        }

        .exchange-select {
            width: 100%;
            max-width: 120px;
            margin: 0 auto;
        }

        /* Новый блок для размера позиции */
        .position-size-row {
            margin: 15px 0;
            text-align: center;
        }

        .position-size-label {
            font-size: 0.9em;
            color: #8b949e;
            margin-bottom: 5px;
        }

        .position-size-input {
            width: 150px;
            margin: 0 auto;
        }

        /* Стили для блока "Текущий профит" */
        .profit-spread {
            margin-bottom: 15px;
        }

        .market-spread {
            margin-bottom: 15px;
        }

        .usdt-pnl {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #30363d;
        }

        /* Мобильная версия */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
                margin: 10px 0 15px 0;
            }
            
            .time-block {
                height: 80px;
                margin: 0 10px 10px 10px;
            }
            
            .ntp-time {
                font-size: 2.5em;
            }
            
            .wrapper {
                display: flex;
                flex-direction: column;
                gap: 10px;
                padding: 0 10px;
            }
            
            .block {
                height: auto;
                min-height: 500px;
                padding: 15px;
            }
            
            .block h2 {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
            
            input, button, select {
                padding: 10px 12px;
                font-size: 16px; /* Для лучшего UX на мобильных */
            }
            
            .content {
                padding: 12px;
                font-size: 0.95em;
            }
            
            .ticker-big {
                font-size: 1.3em;
            }
            
            .spread-big {
                font-size: 1.8em;
            }
            
            .my-spread-num, .current-profit-num {
                font-size: 1.7em;
            }
            
            .position-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .position-section {
                min-height: auto;
            }
            
            .position-input, .exchange-select {
                max-width: 100%;
            }
            
            .position-size-input {
                width: 100%;
            }
            
            .funding-result {
                font-size: 0.95em;
                min-height: 120px;
            }
            
            .funding-line {
                flex-direction: column;
                margin: 8px 0;
            }
            
            .funding-label, .funding-value {
                margin: 2px 0;
            }
        }
    </style>
</head>
<body>
    <!-- Блок времени в самом верху -->
    <div class="time-block">
        <div class="ntp-time" id="ntp-clock">00:00:00</div>
    </div>

    <h1>Spread Alert by Artofskill</h1>

    <div class="wrapper">
        <!-- 1. LIVE спред -->
        <div class="block">
            <h2>LIVE Spread</h2>
            <input type="text" id="ticker" placeholder="Введите тикер" autofocus>
            <div style="margin:10px 0; font-size: 0.9em;">
                ≤ <input type="number" id="min-alert" step="0.01" value="0.80" style="width:70px;"> %
                ≥ <input type="number" id="max-alert" step="0.01" value="2.00" style="width:70px;"> %
            </div>
            <button id="start-btn" onclick="startMonitoring()">СТАРТ</button>
            <button id="stop-btn" onclick="stopMonitoring()" style="display:none;">СТОП</button>
            <div class="content" id="result">Готов к запуску</div>
        </div>

        <!-- 2. Моя позиция -->
        <div class="block">
            <h2>My Position</h2>
            
            <div class="position-container">
                <!-- Long позиция -->
                <div class="position-row">
                    <div class="position-section">
                        <div class="position-title">Long</div>
                        <div class="position-subtitle">Биржа</div>
                        <select id="long-exchange" class="exchange-select">
                            <option value="bybit">Bybit</option>
                            <option value="binance">Binance</option>
                        </select>
                        <div class="position-subtitle">Вход</div>
                        <input type="number" step="0.000001" id="long-price" placeholder="0.146638" class="position-input">
                    </div>
                    
                    <!-- Short позиция -->
                    <div class="position-section">
                        <div class="position-title">Short</div>
                        <div class="position-subtitle">Биржа</div>
                        <select id="short-exchange" class="exchange-select">
                            <option value="bybit">Bybit</option>
                            <option value="binance" selected>Binance</option>
                        </select>
                        <div class="position-subtitle">Вход</div>
                        <input type="number" step="0.000001" id="short-price" placeholder="0.148440" class="position-input">
                    </div>
                </div>

                <!-- Размер позиции -->
                <div class="position-size-row">
                    <div class="position-size-label">Размер позиции (монеты)</div>
                    <input type="number" id="position-size" placeholder="150000" class="position-size-input">
                </div>
            </div>
            
            <button onclick="calcMySpread()">РАССЧИТАТЬ</button>
            <div class="content" id="my-result">—</div>
        </div>

        <!-- 3. Текущий профит -->
        <div class="block">
            <h2>Current Profit</h2>
            <div class="content" id="profit-result">
                Запусти мониторинг и введи позицию
            </div>
        </div>

        <!-- 4. Funding Info -->
        <div class="block">
            <h2>Funding Info</h2>
            <div class="funding-result" id="funding-result">
                Запусти мониторинг
            </div>
        </div>
    </div>

    <!-- JavaScript остается без изменений -->
    <script>
        // NTP-синхронизация времени
        let ntpOffset = 0;

        async function syncNTPTime() {
            try {
                const start = Date.now();
                const response = await fetch('https://worldtimeapi.org/api/ip');
                const data = await response.json();
                const end = Date.now();
                
                const serverTime = new Date(data.utc_datetime).getTime();
                const rtt = end - start;
                ntpOffset = serverTime - start - (rtt / 2);
                
                console.log('NTP синхронизация выполнена. Коррекция: ' + ntpOffset + 'ms');
            } catch (error) {
                console.error('Ошибка NTP синхронизации:', error);
            }
        }

        function getNTPTime() {
            return new Date(Date.now() + ntpOffset);
        }

        function updateNTPClock() {
            const now = getNTPTime();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            document.getElementById('ntp-clock').textContent = `${hours}:${minutes}:${seconds}`;
        }

        // Синхронизация при загрузке и каждые 5 минут
        syncNTPTime();
        setInterval(syncNTPTime, 300000);
        setInterval(updateNTPClock, 1000);

        // Обновленная функция для форматирования времени в 00:00:00
        function msToTime(ms) {
            if (ms <= 0) return "00:00:00";
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Остальной код
        let audioContext;
        function playBeep(freq = 600, duration = 300) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioContext.createOscillator();
            osc.type = 'sine';
            osc.frequency.value = freq;
            const gain = audioContext.createGain();
            gain.gain.value = 0.3;
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + duration/1000);
        }
        function playLow() { playBeep(400, 500); setTimeout(() => playBeep(400, 500), 600); }
        function playHigh() { playBeep(900, 200); setTimeout(() => playBeep(900, 200), 300); setTimeout(() => playBeep(900, 200), 600); }

        let monitorActive = false;
        let lastPrices = { bybit: null, binance: null };
        let myLongPrice = 0;
        let myShortPrice = 0;
        let myLongExchange = 'bybit';
        let myShortExchange = 'binance';
        let mySpread = 0;
        let positionSize = 0;

        async function getPrices(symbol) {
            try {
                const [bybitResp, binanceResp] = await Promise.all([
                    fetch('https://api.bybit.com/v5/market/tickers?category=linear'),
                    fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
                ]);
                const bybitData = await bybitResp.json();
                const binanceData = await binanceResp.json();

                const bybitTicker = bybitData.result.list.find(t => t.symbol === symbol);
                const binanceTicker = binanceData.find(t => t.symbol === symbol);

                if (!bybitTicker || !binanceTicker) return null;

                return {
                    bybitPrice: parseFloat(bybitTicker.markPrice || bybitTicker.lastPrice),
                    binancePrice: parseFloat(binanceTicker.markPrice),
                    bybitRate: parseFloat(bybitTicker.fundingRate) * 100,
                    binanceRate: parseFloat(binanceTicker.lastFundingRate) * 100,
                    bybitNext: parseInt(bybitTicker.nextFundingTime),
                    binanceNext: parseInt(binanceTicker.nextFundingTime)
                };
            } catch (e) {
                return null;
            }
        }

        function getInterval(nextTime) {
            const now = Date.now();
            const diff = (nextTime - now) / 3600000;
            if (Math.abs(diff - 1) < 0.5 || Math.abs(diff - 25) < 0.5) return "1-часовой";
            if (Math.abs(diff - 4) < 0.5 || Math.abs(diff - 28) < 0.5) return "4-часовой";
            return "8-часовой";
        }

        // Функция для получения текущей цены по выбранной бирже
        function getCurrentPrice(exchange) {
            if (exchange === 'bybit') {
                return lastPrices.bybit;
            } else if (exchange === 'binance') {
                return lastPrices.binance;
            }
            return null;
        }

        // Функция для получения данных фандинга по выбранной бирже
        function getFundingData(exchange, data) {
            if (exchange === 'bybit') {
                return {
                    rate: data.bybitRate,
                    nextTime: data.bybitNext,
                    time: msToTime(data.bybitNext - Date.now()),
                    interval: getInterval(data.bybitNext)
                };
            } else if (exchange === 'binance') {
                return {
                    rate: data.binanceRate,
                    nextTime: data.binanceNext,
                    time: msToTime(data.binanceNext - Date.now()),
                    interval: getInterval(data.binanceNext)
                };
            }
            return null;
        }

        // Функция для расчета PnL с учетом выбранных бирж
        function calculatePnL() {
            if (!myLongPrice || !myShortPrice || !lastPrices.bybit || !lastPrices.binance) {
                return null;
            }

            // Получаем текущие цены для выбранных бирж
            const longCurrentPrice = getCurrentPrice(myLongExchange);
            const shortCurrentPrice = getCurrentPrice(myShortExchange);
            
            if (!longCurrentPrice || !shortCurrentPrice) return null;

            // PnL для лонга: (текущая цена - цена входа) / цена входа * 100%
            const longPnLPercent = ((longCurrentPrice - myLongPrice) / myLongPrice * 100).toFixed(3);
            
            // PnL для шорта: (цена входа - текущая цена) / цена входа * 100%
            const shortPnLPercent = ((myShortPrice - shortCurrentPrice) / myShortPrice * 100).toFixed(3);
            
            // Расчет PnL в USDT
            let longPnLUsdt = 0;
            let shortPnLUsdt = 0;
            let totalPnLUsdt = 0;
            
            if (positionSize > 0) {
                longPnLUsdt = (longCurrentPrice - myLongPrice) * positionSize;
                shortPnLUsdt = (myShortPrice - shortCurrentPrice) * positionSize;
                totalPnLUsdt = longPnLUsdt + shortPnLUsdt;
            }
            
            return {
                longPnLPercent: longPnLPercent,
                shortPnLPercent: shortPnLPercent,
                longCurrentPrice: longCurrentPrice,
                shortCurrentPrice: shortCurrentPrice,
                longPnLUsdt: longPnLUsdt,
                shortPnLUsdt: shortPnLUsdt,
                totalPnLUsdt: totalPnLUsdt
            };
        }

        // Обновленная функция для отображения позиции с PnL
        function updatePositionDisplay() {
            if (!myLongPrice || !myShortPrice) {
                document.getElementById('my-result').innerHTML = 'Введи обе цены';
                return;
            }

            const pnlData = calculatePnL();
            
            let pnlHtml = '';
            if (pnlData) {
                pnlHtml = `
                    <div class="pnl-section">
                        <div class="pnl-line">
                            <span class="pnl-label">Long PnL (${myLongExchange.toUpperCase()}):</span>
                            <span class="pnl-value" style="color:${pnlData.longPnLPercent >= 0 ? '#56d364' : '#ff7b72'}">
                                ${pnlData.longPnLPercent >= 0 ? '+' : ''}${pnlData.longPnLPercent}%
                            </span>
                        </div>
                        <div class="pnl-line">
                            <span class="pnl-label">Short PnL (${myShortExchange.toUpperCase()}):</span>
                            <span class="pnl-value" style="color:${pnlData.shortPnLPercent >= 0 ? '#56d364' : '#ff7b72'}">
                                ${pnlData.shortPnLPercent >= 0 ? '+' : ''}${pnlData.shortPnLPercent}%
                            </span>
                        </div>
                        <div class="pnl-line">
                            <span class="pnl-label">Текущая цена Long:</span>
                            <span class="pnl-value">${pnlData.longCurrentPrice.toFixed(6)}</span>
                        </div>
                        <div class="pnl-line">
                            <span class="pnl-label">Текущая цена Short:</span>
                            <span class="pnl-value">${pnlData.shortCurrentPrice.toFixed(6)}</span>
                        </div>
                    </div>
                `;
            }

            document.getElementById('my-result').innerHTML = `
                <div>Long (${myLongExchange.toUpperCase()}) ${myLongPrice}</div>
                <div>Short (${myShortExchange.toUpperCase()}) ${myShortPrice}</div>
                <div class="my-spread-num" style="color:${mySpread > 0 ? '#56d364' : '#ff7b72'}">
                    ${mySpread > 0 ? '+' : ''}${mySpread}%
                </div>
                ${pnlHtml}
            `;
        }

        // Функция для расчета рыночного спреда между выбранными биржами
        function calculateMarketSpread() {
            if (!lastPrices.bybit || !lastPrices.binance) return null;
            
            const longCurrentPrice = getCurrentPrice(myLongExchange);
            const shortCurrentPrice = getCurrentPrice(myShortExchange);
            
            if (!longCurrentPrice || !shortCurrentPrice) return null;
            
            // Рыночный спред: (текущая цена шорта - текущая цена лонга) / текущая цена лонга * 100%
            const marketSpread = ((shortCurrentPrice - longCurrentPrice) / longCurrentPrice * 100).toFixed(3);
            
            return marketSpread;
        }

        // Функция для обновления Funding Info с учетом выбранных бирж
        function updateFundingInfo(data) {
            if (!data) return;
            
            // Получаем данные фандинга для выбранных бирж
            const longFunding = getFundingData(myLongExchange, data);
            const shortFunding = getFundingData(myShortExchange, data);
            
            if (!longFunding || !shortFunding) return;
            
            // Рассчитываем спред фандинга с учетом позиций
            // Для лонга мы платим фандинг, для шорта получаем
            // Поэтому общий эффект: funding_short - funding_long
            const fundingSpread = (shortFunding.rate - longFunding.rate).toFixed(4);
            
            // Чистый фандинг за круг (минус комиссия 0.25%)
            const netFunding = (fundingSpread - 0.25).toFixed(4);
            
            document.getElementById('funding-result').innerHTML = `
                <div class="funding-line">
                    <span class="funding-label">Long funding (${myLongExchange.toUpperCase()}):</span>
                    <span class="funding-value funding-${longFunding.rate >= 0 ? 'positive' : 'negative'}">
                        ${longFunding.rate.toFixed(5)}%
                    </span>
                </div>
                <div class="funding-line">
                    <span class="funding-label">→ через</span>
                    <span class="funding-value">${longFunding.time} (${longFunding.interval})</span>
                </div>
                <div class="funding-line">
                    <span class="funding-label">Short funding (${myShortExchange.toUpperCase()}):</span>
                    <span class="funding-value funding-${shortFunding.rate >= 0 ? 'positive' : 'negative'}">
                        ${shortFunding.rate.toFixed(5)}%
                    </span>
                </div>
                <div class="funding-line">
                    <span class="funding-label">→ через</span>
                    <span class="funding-value">${shortFunding.time} (${shortFunding.interval})</span>
                </div>
                <div class="funding-summary">
                    Спред фандинга (short - long): <strong style="color:${fundingSpread > 0 ? '#56d364' : '#ff7b72'}">
                        ${fundingSpread > 0 ? '+' : ''}${fundingSpread}%
                    </strong><br>
                    Чистый за круг (минус 0.25%): <strong style="color:${netFunding > 0 ? '#56d364' : '#ff7b72'}">
                        ${netFunding > 0 ? '+' : ''}${netFunding}%
                    </strong>
                </div>
            `;
        }

        async function monitorLoop() {
            if (!monitorActive) return;

            const symbol = document.getElementById('ticker').value.trim().toUpperCase() + 'USDT';
            const minAlert = parseFloat(document.getElementById('min-alert').value) || 0;
            const maxAlert = parseFloat(document.getElementById('max-alert').value) || 999;

            const data = await getPrices(symbol);
            if (!data) {
                document.getElementById('result').innerHTML = `<span style="color:#ff7b72">Пара не найдена</span>`;
                setTimeout(monitorLoop, 3000);
                return;
            }

            if (data.bybitPrice !== lastPrices.bybit || data.binancePrice !== lastPrices.binance) {
                lastPrices = { bybit: data.bybitPrice, binance: data.binancePrice };

                // Расчет спреда между Bybit и Binance (для блока LIVE спред)
                const diff = ((data.bybitPrice - data.binancePrice) / data.binancePrice * 100);
                const absDiff = Math.abs(diff).toFixed(3);
                const sign = diff > 0 ? '+' : '';

                let extra = '';
                let className = '';

                if (absDiff <= minAlert && minAlert > 0) {
                    playLow();
                    className = 'alert-min';
                    extra = '<br>СПРЕД ≤ МИНИМУМ!';
                }
                if (absDiff >= maxAlert) {
                    playHigh();
                    className = 'alert-max';
                    extra = '<br>СПРЕД ≥ МАКСИМУМ!';
                }

                document.getElementById('result').className = 'content ' + className;
                document.getElementById('result').innerHTML = `
                    <div class="ticker-big">${symbol.replace('USDT','')}</div>
                    Bybit: <strong>${data.bybitPrice.toFixed(6)}</strong><br>
                    Binance: <strong>${data.binancePrice.toFixed(6)}</strong><br><br>
                    <span class="spread-big" style="color:${diff >= 0 ? '#56d364' : '#ff7b72'}">
                        ${sign}${absDiff}%
                    </span>
                    ${extra}
                `;

                // Обновляем Funding Info с учетом выбранных бирж
                updateFundingInfo(data);

                // Обновляем PnL и профит
                updatePositionDisplay();
                updateProfit();
            }

            setTimeout(monitorLoop, 800);
        }

        function calcMySpread() {
            const longPrice = parseFloat(document.getElementById('long-price').value);
            const shortPrice = parseFloat(document.getElementById('short-price').value);
            const longExchange = document.getElementById('long-exchange').value;
            const shortExchange = document.getElementById('short-exchange').value;
            const size = parseFloat(document.getElementById('position-size').value);

            if (!longPrice || !shortPrice) {
                document.getElementById('my-result').innerHTML = 'Введи обе цены';
                mySpread = 0;
                updateProfit();
                return;
            }

            myLongPrice = longPrice;
            myShortPrice = shortPrice;
            myLongExchange = longExchange;
            myShortExchange = shortExchange;
            positionSize = size || 0;
            
            // Спред рассчитывается как разница между ценами входа
            mySpread = ((shortPrice - longPrice) / longPrice * 100).toFixed(3);

            // Обновляем отображение позиции с PnL
            updatePositionDisplay();
            updateProfit();
        }

        function updateProfit() {
            if (mySpread === 0) {
                document.getElementById('profit-result').innerHTML = 'Введи свою позицию';
                return;
            }

            // Получаем рыночный спред между выбранными биржами
            const marketSpread = calculateMarketSpread();
            
            if (!marketSpread) {
                document.getElementById('profit-result').innerHTML = 'Нет данных по ценам';
                return;
            }

            // Профит = наш спред - текущий рыночный спред
            const profit = (mySpread - marketSpread).toFixed(3);
            const color = profit > 0 ? '#56d364' : '#ff7b72';

            // Расчет PnL в USDT
            const pnlData = calculatePnL();
            let usdtHtml = '';
            
            if (pnlData && positionSize > 0) {
                usdtHtml = `
                    <div class="usdt-pnl">
                        <div class="pnl-line">
                            <span class="pnl-label">Long PnL (USDT):</span>
                            <span class="pnl-value" style="color:${pnlData.longPnLUsdt >= 0 ? '#56d364' : '#ff7b72'}">
                                ${pnlData.longPnLUsdt >= 0 ? '+' : ''}${pnlData.longPnLUsdt.toFixed(2)} USDT
                            </span>
                        </div>
                        <div class="pnl-line">
                            <span class="pnl-label">Short PnL (USDT):</span>
                            <span class="pnl-value" style="color:${pnlData.shortPnLUsdt >= 0 ? '#56d364' : '#ff7b72'}">
                                ${pnlData.shortPnLUsdt >= 0 ? '+' : ''}${pnlData.shortPnLUsdt.toFixed(2)} USDT
                            </span>
                        </div>
                        <div class="pnl-line">
                            <span class="pnl-label">Total PnL (USDT):</span>
                            <span class="pnl-value" style="color:${pnlData.totalPnLUsdt >= 0 ? '#56d364' : '#ff7b72'}">
                                ${pnlData.totalPnLUsdt >= 0 ? '+' : ''}${pnlData.totalPnLUsdt.toFixed(2)} USDT
                            </span>
                        </div>
                    </div>
                `;
            }

            document.getElementById('profit-result').innerHTML = `
                <div class="profit-spread">Твой спред: <strong style="color:#7ffe94">${mySpread > 0 ? '+' : ''}${mySpread}%</strong></div>
                <div class="market-spread">Рыночный спред (${myLongExchange.toUpperCase()}→${myShortExchange.toUpperCase()}): <strong>${marketSpread > 0 ? '+' : ''}${marketSpread}%</strong></div>
                <div class="current-profit-num" style="color:${color}">
                    ${profit > 0 ? '+' : ''}${profit}%
                </div>
                <div style="margin-top:8px;">
                    ${profit > 0 ? 'Можно закрывать!' : 'Ждём схлопывания'}
                </div>
                ${usdtHtml}
            `;
        }

        function startMonitoring() {
            if (monitorActive) return;
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            if (!ticker) return alert('Введите тикер!');
            monitorActive = true;
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-block';
            document.getElementById('result').innerHTML = 'Загрузка...';
            document.getElementById('funding-result').innerHTML = 'Загрузка...';
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            lastPrices = { bybit: null, binance: null };
            monitorLoop();
        }

        function stopMonitoring() {
            monitorActive = false;
            document.getElementById('start-btn').style.display = 'inline-block';
            document.getElementById('stop-btn').style.display = 'none';
            document.getElementById('result').innerHTML = 'Остановлено';
            document.getElementById('result').className = 'content';
            document.getElementById('funding-result').innerHTML = 'Остановлено';
            document.getElementById('profit-result').innerHTML = 'Мониторинг остановлен';
        }
    </script>
</body>
</html>
