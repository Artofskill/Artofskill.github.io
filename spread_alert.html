<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spread Alert</title>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #0d1117; 
            color: #c9d1d9; 
            margin: 0; 
            padding: 0;
        }
h1 {
        text-align: center;
        font-size: 2.8em;
        font-weight: 900;
        background: linear-gradient(90deg, #00f5ff, #ff00ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 20px 0 10px;
    }
    .subtitle {
        text-align: center;
        color: var(--accent2);
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 25px;
    }

        /* –ë–ª–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –≤–≤–µ—Ä—Ö—É */
        .time-block {
            background: #161b22;
            height: 100px;
            margin: 0 15px 15px 15px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            position: relative;
        }

        .ntp-time {
            font-size: 3.5em;
            font-weight: bold;
            color: #ffa657;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px rgba(255, 165, 87, 0.5);
            margin-bottom: 5px;
        }

        /* –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ */
        .refresh-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #58a6ff;
            color: black;
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #79c0ff;
        }

        /* –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ —Ñ–∞–Ω–¥–∏–Ω–≥–∞ */
        .funding-timer {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 5px;
            padding: 5px 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        .funding-timer.green {
            color: #56d364;
            background: rgba(86, 211, 100, 0.1);
            box-shadow: 0 0 10px rgba(86, 211, 100, 0.3);
        }

        .funding-timer.red {
            color: #ff7b72;
            background: rgba(255, 123, 114, 0.1);
            box-shadow: 0 0 10px rgba(255, 123, 114, 0.3);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –≤–µ—Ä—Å–∏–∏ */
        .wrapper { 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            width: 100%;
            margin: 0;
            padding: 0 15px;
            box-sizing: border-box;
        }

        .block { 
            background: #161b22; 
            padding: 18px;
            border-radius: 16px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.6); 
            height: 900px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ (–±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π) */
        .chart-block { 
            background: #161b22; 
            padding: 18px;
            border-radius: 16px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.6); 
            height: 700px; /* –ú–µ–Ω—å—à–µ —á–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –±–ª–æ–∫–∏ */
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            margin-top: 15px;
            grid-column: 1 / -1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É */
        }

        .block h2 { 
            color: #ffa657; 
            margin: 0 0 12px 0; 
            font-size: 1.2em;
            text-align: center;
        }

        .chart-block h2 { 
            color: #58a6ff; 
            margin: 0 0 15px 0; 
            font-size: 1.3em;
            text-align: center;
        }

        input, button, select { 
            padding: 8px 10px;
            font-size: 14px;
            border-radius: 8px; 
            border: none; 
            margin: 4px 0; 
        }
        input { 
            background: #21262d; 
            color: white; 
            text-align: center; 
            width: 100%; 
        }
        select {
            background: #21262d;
            color: white;
            width: 100%;
        }
        button { 
            background: #58a6ff; 
            color: black; 
            font-weight: bold; 
            cursor: pointer; 
        }

        .funding-result {
            margin-top: 12px;
            padding: 15px;
            background: #21262d;
            border-radius: 12px;
            font-size: 1.0em;
            line-height: 1.5;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .funding-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 0 5px;
        }

        .funding-label {
            color: #ffa657;
            font-weight: 600;
            flex: 1;
        }

        .funding-value {
            font-weight: bold;
            flex: 1;
            text-align: right;
        }

        .funding-usdt {
            color: #8b949e;
            font-size: 0.85em;
            margin-top: 2px;
            text-align: right;
        }

        .funding-positive { color: #56d364; }
        .funding-negative { color: #ff7b72; }

        .funding-summary {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #30363d;
            font-size: 1.0em;
            font-weight: bold;
            text-align: center;
        }

        button:hover { background: #79c0ff; }
        button.stop { background: #ff4444; }
        button.stop:hover { background: #ff6666; }

        .content { 
            flex: 1; 
            background: #21262d; 
            border-radius: 12px; 
            padding: 15px;
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            font-size: 1.0em;
            line-height: 1.5;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ */
        .chart-container {
            flex: 1;
            background: #21262d;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        #tradingview-chart {
            width: 100%;
            height: 100%;
            min-height: 600px;
        }

        /* –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ */
        .chart-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }

        .chart-btn {
            background: #58a6ff;
            color: black;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
        }

        .chart-btn:hover {
            background: #79c0ff;
        }

        .chart-btn.update {
            background: #56d364;
        }

        .chart-btn.update:hover {
            background: #7ffe94;
        }

        /* –ï–¥–∏–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤ */
        .ticker-big { 
            font-size: 1.5em; 
            font-weight: 700; 
            color: #58a6ff; 
            margin-bottom: 8px; 
        }
        
        .spread-big { 
            font-size: 2.2em; 
            font-weight: 700; 
            margin: 10px 0; 
        }
        
        .my-spread-num { 
            font-size: 2.0em; 
            font-weight: 700; 
            color: #7ffe94; 
            margin: 10px 0; 
        }
        
        .current-profit-num { 
            font-size: 2.0em; 
            font-weight: 700; 
            margin: 10px 0; 
        }

        .positive { color: #56d364; }
        .negative { color: #ff7b72; }

        .alert-min { animation: flash 0.8s infinite; background: #166534 !important; color: white; }
        .alert-max { animation: flash 0.8s infinite; background: #7f1d1d !important; color: white; }
        @keyframes flash { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* –°—Ç–∏–ª–∏ –¥–ª—è PnL */
        .pnl-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #30363d;
        }

        .pnl-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .pnl-label {
            font-weight: 600;
        }

        .pnl-value {
            font-weight: bold;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏ */
        .commission-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #30363d;
        }

        .commission-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .commission-label {
            font-weight: 600;
            color: #ffa657;
        }

        .commission-value {
            font-weight: bold;
        }

        /* –ù–æ–≤–∞—è —É–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –±–ª–æ–∫–∞ "–ú–æ—è –ø–æ–∑–∏—Ü–∏—è" */
        .position-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .position-row {
            display: flex;
            justify-content: space-between;
            align-items: stretch; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ */
            gap: 10px;
        }

        .position-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 80px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è */
        }

        .position-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffa657;
            margin-bottom: 5px;
            text-align: center;
        }

        .position-subtitle {
            font-size: 0.8em;
            color: #8b949e;
            margin-bottom: 3px;
            text-align: center;
        }

        .position-input {
            width: 100%;
            max-width: 120px;
            margin: 0 auto;
        }

        .exchange-select {
            width: 100%;
            max-width: 120px;
            margin: 0 auto;
        }

        /* –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ */
        .position-size-row {
            margin: 15px 0;
            text-align: center;
        }

        .position-size-label {
            font-size: 0.9em;
            color: #8b949e;
            margin-bottom: 5px;
        }

        .position-size-input {
            width: 150px;
            margin: 0 auto;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ "–¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏—Ç" */
        .profit-spread {
            margin-bottom: 15px;
        }

        .market-spread {
            margin-bottom: 15px;
        }

        .usdt-pnl {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #30363d;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ –≤ USDT */
        .position-usdt {
            margin-top: 8px;
            font-size: 0.9em;
            color: #58a6ff;
            font-weight: bold;
            text-align: center;
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
                margin: 10px 0 15px 0;
            }
            
            .time-block {
                height: 80px;
                margin: 0 10px 10px 10px;
            }
            
            .ntp-time {
                font-size: 2.5em;
            }
            
            .refresh-btn {
                top: 5px;
                right: 10px;
                padding: 4px 8px;
                font-size: 0.7em;
            }
            
            .funding-timer {
                font-size: 1em;
                padding: 3px 10px;
            }
            
            .wrapper {
                display: flex;
                flex-direction: column;
                gap: 10px;
                padding: 0 10px;
            }
            
            .block {
                height: auto;
                min-height: 500px;
                padding: 15px;
            }
            
            .chart-block {
                height: 500px;
                margin-top: 10px;
            }
            
            .block h2 {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
            
            .chart-block h2 {
                font-size: 1.2em;
            }
            
            input, button, select {
                padding: 10px 12px;
                font-size: 16px; /* –î–ª—è –ª—É—á—à–µ–≥–æ UX –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            }
            
            .content {
                padding: 12px;
                font-size: 0.95em;
            }
            
            .ticker-big {
                font-size: 1.3em;
            }
            
            .spread-big {
                font-size: 1.8em;
            }
            
            .my-spread-num, .current-profit-num {
                font-size: 1.7em;
            }
            
            .position-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .position-section {
                min-height: auto;
            }
            
            .position-input, .exchange-select {
                max-width: 100%;
            }
            
            .position-size-input {
                width: 100%;
            }
            
            .funding-result {
                font-size: 0.95em;
                min-height: 120px;
            }
            
            .funding-line {
                flex-direction: column;
                margin: 8px 0;
            }
            
            .funding-label, .funding-value {
                margin: 2px 0;
            }
            
            #tradingview-chart {
                min-height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- –ë–ª–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É -->
    <div class="time-block">
        <button class="refresh-btn" onclick="syncNTPTime()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è</button>
        <div class="ntp-time" id="ntp-clock">00:00:00</div>
        <div class="funding-timer" id="funding-timer" style="display: none;"></div>
    </div>

    <h1>Spread Alert</h1>

    <div class="wrapper">
        <!-- 1. LIVE —Å–ø—Ä–µ–¥ -->
        <div class="block">
            <h2>LIVE Spread</h2>
            <input type="text" id="ticker" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä" autofocus>
            <div style="margin:10px 0; font-size: 0.9em;">
                ‚â§ <input type="number" id="min-alert" step="0.01" value="0.80" style="width:70px;"> %
                ‚â• <input type="number" id="max-alert" step="0.01" value="2.00" style="width:70px;"> %
            </div>
            <button id="start-btn" onclick="startMonitoring()">–°–¢–ê–†–¢</button>
            <button id="stop-btn" onclick="stopMonitoring()" style="display:none;">–°–¢–û–ü</button>
            <div class="content" id="result">–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É</div>
        </div>

        <!-- 2. –ú–æ—è –ø–æ–∑–∏—Ü–∏—è -->
        <div class="block">
            <h2>My Position</h2>
            
            <div class="position-container">
                <!-- Long –ø–æ–∑–∏—Ü–∏—è -->
                <div class="position-row">
                    <div class="position-section">
                        <div class="position-title">Long</div>
                        <div class="position-subtitle">–ë–∏—Ä–∂–∞</div>
                        <select id="long-exchange" class="exchange-select">
                            <option value="bybit">Bybit</option>
                            <option value="binance">Binance</option>
                        </select>
                        <div class="position-subtitle">–í—Ö–æ–¥</div>
                        <input type="number" step="0.000001" id="long-price" placeholder="0.146638" class="position-input" oninput="updatePositionUsdt()">
                    </div>
                    
                    <!-- Short –ø–æ–∑–∏—Ü–∏—è -->
                    <div class="position-section">
                        <div class="position-title">Short</div>
                        <div class="position-subtitle">–ë–∏—Ä–∂–∞</div>
                        <select id="short-exchange" class="exchange-select">
                            <option value="bybit">Bybit</option>
                            <option value="binance" selected>Binance</option>
                        </select>
                        <div class="position-subtitle">–í—Ö–æ–¥</div>
                        <input type="number" step="0.000001" id="short-price" placeholder="0.148440" class="position-input" oninput="updatePositionUsdt()">
                    </div>
                </div>

                <!-- –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ -->
                <div class="position-size-row">
                    <div class="position-size-label">–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ (–º–æ–Ω–µ—Ç—ã)</div>
                    <input type="number" id="position-size" placeholder="150000" class="position-size-input" oninput="updatePositionUsdt()">
                    <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –≤ USDT -->
                    <div class="position-usdt" id="position-usdt-display">–†–∞–∑–º–µ—Ä –≤ USDT: -</div>
                </div>
            </div>
            
            <button onclick="calcMySpread()">–†–ê–°–°–ß–ò–¢–ê–¢–¨</button>
            <div class="content" id="my-result">‚Äî</div>
        </div>

        <!-- 3. –¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏—Ç -->
        <div class="block">
            <h2>Current Profit</h2>
            <div class="content" id="profit-result">
                –ó–∞–ø—É—Å—Ç–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –≤–≤–µ–¥–∏ –ø–æ–∑–∏—Ü–∏—é
            </div>
        </div>

        <!-- 4. Funding Info -->
        <div class="block">
            <h2>Funding Info</h2>
            <div class="funding-result" id="funding-result">
                –ó–∞–ø—É—Å—Ç–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
            </div>
        </div>
    </div>

    <!-- –ë–ª–æ–∫ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ —Å–ø—Ä–µ–¥–∞ -->
    <div class="chart-block">
        <h2>üìà –ì—Ä–∞—Ñ–∏–∫ —Å–ø—Ä–µ–¥–∞ –º–µ–∂–¥—É –±–∏—Ä–∂–∞–º–∏ (Binance / Bybit)</h2>
        <div class="chart-controls">
            <button class="chart-btn update" onclick="updateChart()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
            <button class="chart-btn" onclick="openTradingView()">üåê –û—Ç–∫—Ä—ã—Ç—å –≤ TradingView</button>
        </div>
        <div class="chart-container">
            <div id="tradingview-chart"></div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // NTP-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
        let ntpOffset = 0;
        let fundingTimerActive = false;
        let fundingTimerInterval = null;
        let currentTimerFundingSpread = 0; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø—Ä–µ–¥ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
        let currentTicker = ''; // –¢–µ–∫—É—â–∏–π —Ç–∏–∫–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞

        async function syncNTPTime() {
            try {
                const start = Date.now();
                const response = await fetch('https://worldtimeapi.org/api/ip');
                const data = await response.json();
                const end = Date.now();
                
                const serverTime = new Date(data.utc_datetime).getTime();
                const rtt = end - start;
                ntpOffset = serverTime - start - (rtt / 2);
                
                console.log('NTP —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –ö–æ—Ä—Ä–µ–∫—Ü–∏—è: ' + ntpOffset + 'ms');
                updateNTPClock();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const refreshBtn = document.querySelector('.refresh-btn');
                const originalText = refreshBtn.textContent;
                refreshBtn.textContent = '‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ!';
                refreshBtn.style.background = '#56d364';
                
                setTimeout(() => {
                    refreshBtn.textContent = originalText;
                    refreshBtn.style.background = '#58a6ff';
                }, 2000);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ NTP —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                
                const refreshBtn = document.querySelector('.refresh-btn');
                const originalText = refreshBtn.textContent;
                refreshBtn.textContent = '‚úó –û—à–∏–±–∫–∞!';
                refreshBtn.style.background = '#ff7b72';
                
                setTimeout(() => {
                    refreshBtn.textContent = originalText;
                    refreshBtn.style.background = '#58a6ff';
                }, 2000);
            }
        }

        function getNTPTime() {
            return new Date(Date.now() + ntpOffset);
        }

        function updateNTPClock() {
            const now = getNTPTime();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            document.getElementById('ntp-clock').textContent = `${hours}:${minutes}:${seconds}`;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞ —Ñ–∞–Ω–¥–∏–Ω–≥–∞
        function updateFundingTimer(nextFundingTime, fundingSpread) {
            const now = Date.now();
            const timeLeft = nextFundingTime - now;
            
            if (timeLeft <= 0) {
                document.getElementById('funding-timer').style.display = 'none';
                fundingTimerActive = false;
                if (fundingTimerInterval) {
                    clearInterval(fundingTimerInterval);
                }
                return;
            }
            
            const hours = Math.floor(timeLeft / 3600000);
            const minutes = Math.floor((timeLeft % 3600000) / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            
            const timerText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ 1 —á–∞—Å–∞
            if (timeLeft <= 3600000) { // 1 —á–∞—Å –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
                const timerElement = document.getElementById('funding-timer');
                timerElement.textContent = `–§–∞–Ω–¥–∏–Ω–≥ —á–µ—Ä–µ–∑: ${timerText}`;
                timerElement.style.display = 'block';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ø—Ä–µ–¥ –∏–∑–º–µ–Ω–∏–ª—Å—è
                if (fundingSpread !== currentTimerFundingSpread) {
                    currentTimerFundingSpread = fundingSpread;
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ø—Ä–µ–¥–∞ —Ñ–∞–Ω–¥–∏–Ω–≥–∞
                    if (fundingSpread >= 0) {
                        timerElement.className = 'funding-timer green';
                    } else {
                        timerElement.className = 'funding-timer red';
                    }
                }
                
                fundingTimerActive = true;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
                if (!fundingTimerInterval) {
                    fundingTimerInterval = setInterval(() => {
                        updateFundingTimer(nextFundingTime, currentTimerFundingSpread);
                    }, 1000);
                }
            } else {
                document.getElementById('funding-timer').style.display = 'none';
                fundingTimerActive = false;
                if (fundingTimerInterval) {
                    clearInterval(fundingTimerInterval);
                    fundingTimerInterval = null;
                }
            }
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        syncNTPTime();
        setInterval(syncNTPTime, 300000);
        setInterval(updateNTPClock, 1000);

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ 00:00:00
        function msToTime(ms) {
            if (ms <= 0) return "00:00:00";
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ –≤ USDT
        function updatePositionUsdt() {
            const positionSize = parseFloat(document.getElementById('position-size').value);
            const shortPrice = parseFloat(document.getElementById('short-price').value);
            const longPrice = parseFloat(document.getElementById('long-price').value);
            
            if (positionSize && shortPrice) {
                // –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –≤ USDT (–ø–æ —Ü–µ–Ω–µ —à–æ—Ä—Ç–∞)
                const positionUsdt = positionSize * shortPrice;
                document.getElementById('position-usdt-display').innerHTML = 
                    `–†–∞–∑–º–µ—Ä –≤ USDT: <strong>${positionUsdt.toFixed(2)} USDT</strong>`;
            } else {
                document.getElementById('position-usdt-display').innerHTML = 
                    '–†–∞–∑–º–µ—Ä –≤ USDT: -';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω
        document.getElementById('short-price').addEventListener('input', updatePositionUsdt);
        document.getElementById('long-price').addEventListener('input', updatePositionUsdt);

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ –ø–æ–∑–∏—Ü–∏–∏
        function calculateCommission() {
            const positionSize = parseFloat(document.getElementById('position-size').value);
            const longPrice = parseFloat(document.getElementById('long-price').value);
            const shortPrice = parseFloat(document.getElementById('short-price').value);
            
            if (!positionSize || !longPrice || !shortPrice) {
                return null;
            }
            
            // –°—É–º–º–∞ –ø–æ–∑–∏—Ü–∏–π –≤ USDT
            const longPositionUsdt = positionSize * longPrice;
            const shortPositionUsdt = positionSize * shortPrice;
            const totalPositionUsdt = longPositionUsdt + shortPositionUsdt;
            
            // –ö–æ–º–∏—Å—Å–∏—è 0.25%
            const commissionUsdt = totalPositionUsdt * 0.0025; // 0.25% = 0.0025
            
            return {
                longPositionUsdt: longPositionUsdt,
                shortPositionUsdt: shortPositionUsdt,
                totalPositionUsdt: totalPositionUsdt,
                commissionUsdt: commissionUsdt
            };
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ñ–∞–Ω–¥–∏–Ω–≥–∞ –≤ USDT
        function calculateFundingUsdt(fundingRatePercent, exchange, positionSize) {
            if (!positionSize || positionSize <= 0) return 0;
            
            let price = 0;
            if (exchange === 'long') {
                price = parseFloat(document.getElementById('long-price').value);
            } else if (exchange === 'short') {
                price = parseFloat(document.getElementById('short-price').value);
            }
            
            if (!price) return 0;
            
            // –†–∞—Å—á–µ—Ç: fundingRate (–≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö) √ó –ø–æ–∑–∏—Ü–∏—è –≤ USDT / 100
            const positionUsdt = positionSize * price;
            const fundingUsdt = (fundingRatePercent * positionUsdt) / 100;
            
            return fundingUsdt;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ TradingView
        function loadTradingViewChart(ticker) {
            if (!ticker || ticker.trim() === '') {
                document.getElementById('tradingview-chart').innerHTML = 
                    '<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #8b949e;">–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</div>';
                return;
            }
            
            const symbol = ticker.toUpperCase() + 'USDT';
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –≤—ã—á–∏—Ç–∞–Ω–∏—è
            const expression = `BINANCE:${symbol}.P/BYBIT:${symbol}.P`;
            
            currentTicker = symbol;
            
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ —Å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ–º:', expression);
            
            // –°–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç TradingView
            try {
                new TradingView.widget({
                    "container_id": "tradingview-chart",
                    "width": "100%",
                    "height": "100%",
                    "symbol": expression,
                    "interval": "15",
                    "timezone": "exchange",
                    "theme": "dark",
                    "style": "1",
                    "locale": "ru",
                    "toolbar_bg": "#0d1117",
                    "enable_publishing": false,
                    "allow_symbol_change": false,
                    "hide_side_toolbar": false,
                    "details": true,
                    "studies": [
                        "MASimple@tv-basicstudies",
                        "Volume@tv-basicstudies"
                    ],
                    "show_popup_button": true,
                    "popup_width": "1000",
                    "popup_height": "650",
                    "overrides": {
                        "mainSeriesProperties.priceAxisProperties.percentage": true, // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
                        "paneProperties.background": "#0d1117",
                        "paneProperties.vertGridProperties.color": "#30363d",
                        "paneProperties.horzGridProperties.color": "#30363d"
                    }
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ TradingView:', error);
                document.getElementById('tradingview-chart').innerHTML = 
                    '<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #ff7b72; text-align: center; padding: 20px;">' +
                    '<div>' +
                    '<div style="font-size: 1.5em; margin-bottom: 10px;">‚ö†Ô∏è</div>' +
                    '<div style="font-weight: bold; margin-bottom: 5px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞</div>' +
                    '<div>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É<br>–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∏–∫–µ—Ä</div>' +
                    '</div>' +
                    '</div>';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        function updateChart() {
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            if (!ticker) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞!');
                return;
            }
            
            loadTradingViewChart(ticker);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const updateBtn = document.querySelector('.chart-btn.update');
            const originalText = updateBtn.textContent;
            updateBtn.textContent = '‚úì –ì—Ä–∞—Ñ–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω!';
            updateBtn.style.background = '#56d364';
            
            setTimeout(() => {
                updateBtn.textContent = originalText;
                updateBtn.style.background = '#56d364';
            }, 2000);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤ TradingView
        function openTradingView() {
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            if (!ticker) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≥—Ä–∞—Ñ–∏–∫–∞!');
                return;
            }
            
            const symbol = ticker + 'USDT';
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–Ω–∏–µ
            const expression = `BINANCE:${symbol}.P/BYBIT:${symbol}.P`;
            const url = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(expression)}`;
            
            window.open(url, '_blank');
        }

        // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
        let audioContext;
        function playBeep(freq = 600, duration = 300) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioContext.createOscillator();
            osc.type = 'sine';
            osc.frequency.value = freq;
            const gain = audioContext.createGain();
            gain.gain.value = 0.3;
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + duration/1000);
        }
        function playLow() { playBeep(400, 500); setTimeout(() => playBeep(400, 500), 600); }
        function playHigh() { playBeep(900, 200); setTimeout(() => playBeep(900, 200), 300); setTimeout(() => playBeep(900, 200), 600); }

        let monitorActive = false;
        let lastPrices = { bybit: null, binance: null };
        let myLongPrice = 0;
        let myShortPrice = 0;
        let myLongExchange = 'bybit';
        let myShortExchange = 'binance';
        let mySpread = 0;
        let positionSize = 0;
        let currentFundingSpread = 0;
        let nextFundingTime = 0;

        async function getPrices(symbol) {
            try {
                const [bybitResp, binanceResp] = await Promise.all([
                    fetch('https://api.bybit.com/v5/market/tickers?category=linear'),
                    fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
                ]);
                const bybitData = await bybitResp.json();
                const binanceData = await binanceResp.json();

                const bybitTicker = bybitData.result.list.find(t => t.symbol === symbol);
                const binanceTicker = binanceData.find(t => t.symbol === symbol);

                if (!bybitTicker || !binanceTicker) return null;

                return {
                    bybitPrice: parseFloat(bybitTicker.markPrice || bybitTicker.lastPrice),
                    binancePrice: parseFloat(binanceTicker.markPrice),
                    bybitRate: parseFloat(bybitTicker.fundingRate) * 100,
                    binanceRate: parseFloat(binanceTicker.lastFundingRate) * 100,
                    bybitNext: parseInt(bybitTicker.nextFundingTime),
                    binanceNext: parseInt(binanceTicker.nextFundingTime)
                };
            } catch (e) {
                return null;
            }
        }

        function getInterval(nextTime) {
            const now = Date.now();
            const diff = (nextTime - now) / 3600000;
            if (Math.abs(diff - 1) < 0.5 || Math.abs(diff - 25) < 0.5) return "1-—á–∞—Å–æ–≤–æ–π";
            if (Math.abs(diff - 4) < 0.5 || Math.abs(diff - 28) < 0.5) return "4-—á–∞—Å–æ–≤–æ–π";
            return "8-—á–∞—Å–æ–≤–æ–π";
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –±–∏—Ä–∂–µ
        function getCurrentPrice(exchange) {
            if (exchange === 'bybit') {
                return lastPrices.bybit;
            } else if (exchange === 'binance') {
                return lastPrices.binance;
            }
            return null;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–∞–Ω–¥–∏–Ω–≥–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –±–∏—Ä–∂–µ
        function getFundingData(exchange, data) {
            if (exchange === 'bybit') {
                return {
                    rate: data.bybitRate,
                    nextTime: data.bybitNext,
                    time: msToTime(data.bybitNext - Date.now()),
                    interval: getInterval(data.bybitNext)
                };
            } else if (exchange === 'binance') {
                return {
                    rate: data.binanceRate,
                    nextTime: data.binanceNext,
                    time: msToTime(data.binanceNext - Date.now()),
                    interval: getInterval(data.binanceNext)
                };
            }
            return null;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ PnL —Å —É—á–µ—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∏—Ä–∂
        function calculatePnL() {
            if (!myLongPrice || !myShortPrice || !lastPrices.bybit || !lastPrices.binance) {
                return null;
            }

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∏—Ä–∂
            const longCurrentPrice = getCurrentPrice(myLongExchange);
            const shortCurrentPrice = getCurrentPrice(myShortExchange);
            
            if (!longCurrentPrice || !shortCurrentPrice) return null;

            // PnL –¥–ª—è –ª–æ–Ω–≥–∞: (—Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ - —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞) / —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞ * 100%
            const longPnLPercent = ((longCurrentPrice - myLongPrice) / myLongPrice * 100).toFixed(3);
            
            // PnL –¥–ª—è —à–æ—Ä—Ç–∞: (—Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞ - —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞) / —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞ * 100%
            const shortPnLPercent = ((myShortPrice - shortCurrentPrice) / myShortPrice * 100).toFixed(3);
            
            // –†–∞—Å—á–µ—Ç PnL –≤ USDT
            let longPnLUsdt = 0;
            let shortPnLUsdt = 0;
            let totalPnLUsdt = 0;
            
            if (positionSize > 0) {
                longPnLUsdt = (longCurrentPrice - myLongPrice) * positionSize;
                shortPnLUsdt = (myShortPrice - shortCurrentPrice) * positionSize;
                totalPnLUsdt = longPnLUsdt + shortPnLUsdt;
            }
            
            return {
                longPnLPercent: longPnLPercent,
                shortPnLPercent: shortPnLPercent,
                longCurrentPrice: longCurrentPrice,
                shortCurrentPrice: shortCurrentPrice,
                longPnLUsdt: longPnLUsdt,
                shortPnLUsdt: shortPnLUsdt,
                totalPnLUsdt: totalPnLUsdt
            };
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ —Å PnL –∏ –∫–æ–º–∏—Å—Å–∏–µ–π
        function updatePositionDisplay() {
            if (!myLongPrice || !myShortPrice) {
                document.getElementById('my-result').innerHTML = '–í–≤–µ–¥–∏ –æ–±–µ —Ü–µ–Ω—ã';
                return;
            }

            const pnlData = calculatePnL();
            const commissionData = calculateCommission();
            
            let pnlHtml = '';
            if (pnlData) {
                pnlHtml = `
                    <div class="pnl-section">
                        <div class="pnl-line">
                            <span class="pnl-label">Long PnL (${myLongExchange.toUpperCase()}):</span>
                            <span class="pnl-value" style="color:${pnlData.longPnLPercent >= 0 ? '#56d364' : '#ff7b72'}">
                                ${pnlData.longPnLPercent >= 0 ? '+' : ''}${pnlData.longPnLPercent}%
                            </span>
                        </div>
                        <div class="pnl-line">
                            <span class="pnl-label">Short PnL (${myShortExchange.toUpperCase()}):</span>
                            <span class="pnl-value" style="color:${pnlData.shortPnLPercent >= 0 ? '#56d364' : '#ff7b72'}">
                                ${pnlData.shortPnLPercent >= 0 ? '+' : ''}${pnlData.shortPnLPercent}%
                            </span>
                        </div>
                        <div class="pnl-line">
                            <span class="pnl-label">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ Long:</span>
                            <span class="pnl-value">${pnlData.longCurrentPrice.toFixed(6)}</span>
                        </div>
                        <div class="pnl-line">
                            <span class="pnl-label">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ Short:</span>
                            <span class="pnl-value">${pnlData.shortCurrentPrice.toFixed(6)}</span>
                        </div>
                    </div>
                `;
            }
            
            let commissionHtml = '';
            if (commissionData) {
                commissionHtml = `
                    <div class="commission-section">
                        <div class="commission-line">
                            <span class="commission-label">–ö–æ–º–∏—Å—Å–∏—è –∑–∞ –ø–æ–∑–∏—Ü–∏–∏:</span>
                            <span class="commission-value">${commissionData.commissionUsdt.toFixed(2)} USDT</span>
                        </div>
                        <div style="font-size: 0.8em; color: #8b949e; margin-top: 3px;">
                            Long: ${commissionData.longPositionUsdt.toFixed(2)} USDT + Short: ${commissionData.shortPositionUsdt.toFixed(2)} USDT = ${commissionData.totalPositionUsdt.toFixed(2)} USDT √ó 0.25%
                        </div>
                    </div>
                `;
            }

            document.getElementById('my-result').innerHTML = `
                <div>Long (${myLongExchange.toUpperCase()}) ${myLongPrice}</div>
                <div>Short (${myShortExchange.toUpperCase()}) ${myShortPrice}</div>
                <div class="my-spread-num" style="color:${mySpread > 0 ? '#56d364' : '#ff7b72'}">
                    ${mySpread > 0 ? '+' : ''}${mySpread}%
                </div>
                ${pnlHtml}
                ${commissionHtml}
            `;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –≤ USDT –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ
            updatePositionUsdt();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä—ã–Ω–æ—á–Ω–æ–≥–æ —Å–ø—Ä–µ–¥–∞ –º–µ–∂–¥—É –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –±–∏—Ä–∂–∞–º–∏
        function calculateMarketSpread() {
            if (!lastPrices.bybit || !lastPrices.binance) return null;
            
            const longCurrentPrice = getCurrentPrice(myLongExchange);
            const shortCurrentPrice = getCurrentPrice(myShortExchange);
            
            if (!longCurrentPrice || !shortCurrentPrice) return null;
            
            // –†—ã–Ω–æ—á–Ω—ã–π —Å–ø—Ä–µ–¥: (—Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ —à–æ—Ä—Ç–∞ - —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –ª–æ–Ω–≥–∞) / —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –ª–æ–Ω–≥–∞ * 100%
            const marketSpread = ((shortCurrentPrice - longCurrentPrice) / longCurrentPrice * 100).toFixed(3);
            
            return marketSpread;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Funding Info
        function updateFundingInfo(data) {
            if (!data) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–∞–Ω–¥–∏–Ω–≥–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∏—Ä–∂
            const longFunding = getFundingData(myLongExchange, data);
            const shortFunding = getFundingData(myShortExchange, data);
            
            if (!longFunding || !shortFunding) return;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–ø—Ä–µ–¥ —Ñ–∞–Ω–¥–∏–Ω–≥–∞ —Å —É—á–µ—Ç–æ–º –ø–æ–∑–∏—Ü–∏–π
            // –î–ª—è –ª–æ–Ω–≥–∞ –º—ã –ø–ª–∞—Ç–∏–º —Ñ–∞–Ω–¥–∏–Ω–≥, –¥–ª—è —à–æ—Ä—Ç–∞ –ø–æ–ª—É—á–∞–µ–º
            // –ü–æ—ç—Ç–æ–º—É –æ–±—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç: funding_short - funding_long
            const fundingSpread = (shortFunding.rate - longFunding.rate).toFixed(4);
            currentFundingSpread = parseFloat(fundingSpread);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è —Ñ–∞–Ω–¥–∏–Ω–≥–∞
            nextFundingTime = Math.min(longFunding.nextTime, shortFunding.nextTime);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä —Ñ–∞–Ω–¥–∏–Ω–≥–∞
            updateFundingTimer(nextFundingTime, currentFundingSpread);
            
            // –†–∞—Å—á–µ—Ç —Ñ–∞–Ω–¥–∏–Ω–≥–∞ –≤ USDT –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
            // –í–ê–ñ–ù–û: –î–ª—è –ª–æ–Ω–≥–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–Ω–¥–∏–Ω–≥ = –º—ã –ø–æ–ª—É—á–∞–µ–º –¥–µ–Ω—å–≥–∏, –∞ –Ω–µ –ø–ª–∞—Ç–∏–º!
            // –î–ª—è —à–æ—Ä—Ç–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–Ω–¥–∏–Ω–≥ = –º—ã –ø–æ–ª—É—á–∞–µ–º –¥–µ–Ω—å–≥–∏
            const longFundingUsdt = calculateFundingUsdt(longFunding.rate, 'long', positionSize);
            const shortFundingUsdt = calculateFundingUsdt(shortFunding.rate, 'short', positionSize);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–Ω–∞–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ USDT
            // –î–ª—è –ª–æ–Ω–≥–∞: –µ—Å–ª–∏ —Ñ–∞–Ω–¥–∏–Ω–≥ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ‚Üí –º—ã –ø–æ–ª—É—á–∞–µ–º ‚Üí "+"
            const longFundingDisplayUsdt = longFundingUsdt * -1; // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞–∫ –¥–ª—è –ª–æ–Ω–≥–∞
            const shortFundingDisplayUsdt = shortFundingUsdt;
            
            // –û–±—â–∏–π —Ñ–∞–Ω–¥–∏–Ω–≥ –≤ USDT
            const totalFundingUsdt = shortFundingUsdt - longFundingUsdt;
            
            document.getElementById('funding-result').innerHTML = `
                <div class="funding-line">
                    <span class="funding-label">Long funding (${myLongExchange.toUpperCase()}):</span>
                    <div>
                        <span class="funding-value funding-${longFunding.rate >= 0 ? 'positive' : 'negative'}">
                            ${longFunding.rate.toFixed(5)}%
                        </span>
                        ${positionSize > 0 ? `<div class="funding-usdt" style="color:${longFundingDisplayUsdt >= 0 ? '#56d364' : '#ff7b72'}">${longFundingDisplayUsdt >= 0 ? '+' : ''}${longFundingDisplayUsdt.toFixed(4)} USDT</div>` : ''}
                    </div>
                </div>
                <div class="funding-line">
                    <span class="funding-label">‚Üí —á–µ—Ä–µ–∑</span>
                    <span class="funding-value">${longFunding.time} (${longFunding.interval})</span>
                </div>
                <div class="funding-line">
                    <span class="funding-label">Short funding (${myShortExchange.toUpperCase()}):</span>
                    <div>
                        <span class="funding-value funding-${shortFunding.rate >= 0 ? 'positive' : 'negative'}">
                            ${shortFunding.rate.toFixed(5)}%
                        </span>
                        ${positionSize > 0 ? `<div class="funding-usdt" style="color:${shortFundingDisplayUsdt >= 0 ? '#56d364' : '#ff7b72'}">${shortFundingDisplayUsdt >= 0 ? '+' : ''}${shortFundingDisplayUsdt.toFixed(4)} USDT</div>` : ''}
                    </div>
                </div>
                <div class="funding-line">
                    <span class="funding-label">‚Üí —á–µ—Ä–µ–∑</span>
                    <span class="funding-value">${shortFunding.time} (${shortFunding.interval})</span>
                </div>
                <div class="funding-summary">
                    –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å —Ñ–∞–Ω–¥–∏–Ω–≥–∞ (short - long): <strong style="color:${fundingSpread > 0 ? '#56d364' : '#ff7b72'}">
                        ${fundingSpread > 0 ? '+' : ''}${fundingSpread}%
                    </strong>
                    ${positionSize > 0 ? `<div style="margin-top: 5px; font-size: 0.9em; color: ${totalFundingUsdt >= 0 ? '#56d364' : '#ff7b72'}">${totalFundingUsdt >= 0 ? '+' : ''}${totalFundingUsdt.toFixed(4)} USDT</div>` : ''}
                </div>
            `;
        }

        async function monitorLoop() {
            if (!monitorActive) return;

            const symbol = document.getElementById('ticker').value.trim().toUpperCase() + 'USDT';
            const minAlert = parseFloat(document.getElementById('min-alert').value) || 0;
            const maxAlert = parseFloat(document.getElementById('max-alert').value) || 999;

            const data = await getPrices(symbol);
            if (!data) {
                document.getElementById('result').innerHTML = `<span style="color:#ff7b72">–ü–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</span>`;
                setTimeout(monitorLoop, 3000);
                return;
            }

            if (data.bybitPrice !== lastPrices.bybit || data.binancePrice !== lastPrices.binance) {
                lastPrices = { bybit: data.bybitPrice, binance: data.binancePrice };

                // –†–∞—Å—á–µ—Ç —Å–ø—Ä–µ–¥–∞ –º–µ–∂–¥—É Bybit –∏ Binance (–¥–ª—è –±–ª–æ–∫–∞ LIVE —Å–ø—Ä–µ–¥)
                const diff = ((data.bybitPrice - data.binancePrice) / data.binancePrice * 100);
                const absDiff = Math.abs(diff).toFixed(3);
                const sign = diff > 0 ? '+' : '';

                let extra = '';
                let className = '';

                if (absDiff <= minAlert && minAlert > 0) {
                    playLow();
                    className = 'alert-min';
                    extra = '<br>–°–ü–†–ï–î ‚â§ –ú–ò–ù–ò–ú–£–ú!';
                }
                if (absDiff >= maxAlert) {
                    playHigh();
                    className = 'alert-max';
                    extra = '<br>–°–ü–†–ï–î ‚â• –ú–ê–ö–°–ò–ú–£–ú!';
                }

                document.getElementById('result').className = 'content ' + className;
                document.getElementById('result').innerHTML = `
                    <div class="ticker-big">${symbol.replace('USDT','')}</div>
                    Bybit: <strong>${data.bybitPrice.toFixed(6)}</strong><br>
                    Binance: <strong>${data.binancePrice.toFixed(6)}</strong><br><br>
                    <span class="spread-big" style="color:${diff >= 0 ? '#56d364' : '#ff7b72'}">
                        ${sign}${absDiff}%
                    </span>
                    ${extra}
                `;

                // –û–±–Ω–æ–≤–ª—è–µ–º Funding Info
                updateFundingInfo(data);

                // –û–±–Ω–æ–≤–ª—è–µ–º PnL –∏ –ø—Ä–æ—Ñ–∏—Ç
                updatePositionDisplay();
                updateProfit();
            }

            setTimeout(monitorLoop, 800);
        }

        function calcMySpread() {
            const longPrice = parseFloat(document.getElementById('long-price').value);
            const shortPrice = parseFloat(document.getElementById('short-price').value);
            const longExchange = document.getElementById('long-exchange').value;
            const shortExchange = document.getElementById('short-exchange').value;
            const size = parseFloat(document.getElementById('position-size').value);

            if (!longPrice || !shortPrice) {
                document.getElementById('my-result').innerHTML = '–í–≤–µ–¥–∏ –æ–±–µ —Ü–µ–Ω—ã';
                mySpread = 0;
                updateProfit();
                return;
            }

            myLongPrice = longPrice;
            myShortPrice = shortPrice;
            myLongExchange = longExchange;
            myShortExchange = shortExchange;
            positionSize = size || 0;
            
            // –°–ø—Ä–µ–¥ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Ü–µ–Ω–∞–º–∏ –≤—Ö–æ–¥–∞
            mySpread = ((shortPrice - longPrice) / longPrice * 100).toFixed(3);

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å PnL –∏ –∫–æ–º–∏—Å—Å–∏–µ–π
            updatePositionDisplay();
            updateProfit();
        }

        function updateProfit() {
            if (mySpread === 0) {
                document.getElementById('profit-result').innerHTML = '–í–≤–µ–¥–∏ —Å–≤–æ—é –ø–æ–∑–∏—Ü–∏—é';
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º —Ä—ã–Ω–æ—á–Ω—ã–π —Å–ø—Ä–µ–¥ –º–µ–∂–¥—É –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∏—Ä–∂
            const marketSpread = calculateMarketSpread();
            
            if (!marketSpread) {
                document.getElementById('profit-result').innerHTML = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ü–µ–Ω–∞–º';
                return;
            }

            // –ü—Ä–æ—Ñ–∏—Ç = –Ω–∞—à —Å–ø—Ä–µ–¥ - —Ç–µ–∫—É—â–∏–π —Ä—ã–Ω–æ—á–Ω—ã–π —Å–ø—Ä–µ–¥
            const profit = (mySpread - marketSpread).toFixed(3);
            const color = profit > 0 ? '#56d364' : '#ff7b72';

            // –†–∞—Å—á–µ—Ç PnL –≤ USDT
            const pnlData = calculatePnL();
            let usdtHtml = '';
            
            if (pnlData && positionSize > 0) {
                usdtHtml = `
                    <div class="usdt-pnl">
                        <div class="pnl-line">
                            <span class="pnl-label">Long PnL (USDT):</span>
                            <span class="pnl-value" style="color:${pnlData.longPnLUsdt >= 0 ? '#56d364' : '#ff7b72'}">
                                ${pnlData.longPnLUsdt >= 0 ? '+' : ''}${pnlData.longPnLUsdt.toFixed(2)} USDT
                            </span>
                        </div>
                        <div class="pnl-line">
                            <span class="pnl-label">Short PnL (USDT):</span>
                            <span class="pnl-value" style="color:${pnlData.shortPnLUsdt >= 0 ? '#56d364' : '#ff7b72'}">
                                ${pnlData.shortPnLUsdt >= 0 ? '+' : ''}${pnlData.shortPnLUsdt.toFixed(2)} USDT
                            </span>
                        </div>
                        <div class="pnl-line">
                            <span class="pnl-label">Total PnL (USDT):</span>
                            <span class="pnl-value" style="color:${pnlData.totalPnLUsdt >= 0 ? '#56d364' : '#ff7b72'}">
                                ${pnlData.totalPnLUsdt >= 0 ? '+' : ''}${pnlData.totalPnLUsdt.toFixed(2)} USDT
                            </span>
                        </div>
                    </div>
                `;
            }

            document.getElementById('profit-result').innerHTML = `
                <div class="profit-spread">–¢–≤–æ–π —Å–ø—Ä–µ–¥: <strong style="color:#7ffe94">${mySpread > 0 ? '+' : ''}${mySpread}%</strong></div>
                <div class="market-spread">–†—ã–Ω–æ—á–Ω—ã–π —Å–ø—Ä–µ–¥ (${myLongExchange.toUpperCase()}‚Üí${myShortExchange.toUpperCase()}): <strong>${marketSpread > 0 ? '+' : ''}${marketSpread}%</strong></div>
                <div class="current-profit-num" style="color:${color}">
                    ${profit > 0 ? '+' : ''}${profit}%
                </div>
                <div style="margin-top:8px;">
                    ${profit > 0 ? '–ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å!' : '–ñ–¥—ë–º —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏—è'}
                </div>
                ${usdtHtml}
            `;
        }

        function startMonitoring() {
            if (monitorActive) return;
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            if (!ticker) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä!');
            monitorActive = true;
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-block';
            document.getElementById('result').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            document.getElementById('funding-result').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            lastPrices = { bybit: null, binance: null };
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            loadTradingViewChart(ticker);
            
            monitorLoop();
        }

        function stopMonitoring() {
            monitorActive = false;
            document.getElementById('start-btn').style.display = 'inline-block';
            document.getElementById('stop-btn').style.display = 'none';
            document.getElementById('result').innerHTML = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
            document.getElementById('result').className = 'content';
            document.getElementById('funding-result').innerHTML = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
            document.getElementById('profit-result').innerHTML = '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä —Ñ–∞–Ω–¥–∏–Ω–≥–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
            document.getElementById('funding-timer').style.display = 'none';
            fundingTimerActive = false;
            if (fundingTimerInterval) {
                clearInterval(fundingTimerInterval);
                fundingTimerInterval = null;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            updatePositionUsdt();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–ª–æ–∫–µ –≥—Ä–∞—Ñ–∏–∫–∞
            document.getElementById('tradingview-chart').innerHTML = 
                '<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #8b949e; text-align: center; padding: 20px;">' +
                '<div>' +
                '<div style="font-size: 1.5em; margin-bottom: 10px;">üìà</div>' +
                '<div style="font-weight: bold; margin-bottom: 5px;">–ì—Ä–∞—Ñ–∏–∫ —Å–ø—Ä–µ–¥–∞ –º–µ–∂–¥—É –±–∏—Ä–∂–∞–º–∏</div>' +
                '<div>–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–¢–ê–†–¢"<br>–∏–ª–∏ –∫–Ω–æ–ø–∫—É "–û–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫"</div>' +
                '</div>' +
                '</div>';
        });
    </script>
    
    <!-- TradingView Widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</body>
</html>

